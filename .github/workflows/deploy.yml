name: Deploy to Server

on:
  push:
    branches:
      - main # Déclencher l'action seulement pour la branche `main`

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Nouvelle étape pour créer les fichiers .env
      - name: Create Environment Files
        run: |
          echo "${{ secrets.ENV_PRODUCTION }}" > .env.production
          echo "${{ secrets.ENV_DEVELOPMENT }}" > .env.development

      # Mise à jour de la version
      - name: Update Application Version
        run: |
          node Front-End/scripts/update-version.js
          echo "Version de l'application mise à jour avec succès."

      # Génération du hash de build
      - name: Generate Build Hash
        run: |
          node Front-End/scripts/generate-build-info.js
          echo "Hash de build généré avec succès."

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.5.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Add SSH known hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Copy Files to Server
        run: |
          rsync -avz --delete --exclude='.git' -e "ssh -p ${{ secrets.SSH_PORT }}" . ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.SERVER_DIR }}
